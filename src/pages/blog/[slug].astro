---
import { render } from "astro:content";

import PostMetaView from "../../components/PostMeta.astro";
import SiteLayout from "../../layouts/SiteLayout.astro";
import { getAllPostMeta, getPostBySlug } from "../../lib/content";

import Callout from "../../components/mdx/Callout.astro";
import Quote from "../../components/mdx/Quote.astro";
import Highlight from "../../components/mdx/Highlight.astro";
import Divider from "../../components/mdx/Divider.astro";

const components = {
  Callout,
  Quote,
  Highlight,
  Divider,
};

export async function getStaticPaths() {
  const posts = await getAllPostMeta();

  return posts.map((post) => ({
    params: {
      slug: post.slug,
    },
  }));
}

const { slug } = Astro.params;

if (!slug) {
  throw new Error("Missing slug parameter.");
}

const result = await getPostBySlug(slug);

if (!result) {
  throw new Error(`Post not found for slug "${slug}"`);
}

const { Content, headings } = await render(result.post);
const { meta } = result;

const filteredHeadings = headings.filter((h: { depth: number }) => h.depth <= 2);
---

<SiteLayout
  title={meta.title}
  description={meta.summary}
  path={meta.routePath}
  image={meta.coverImage}
  type='article'
>
  <div class='grid grid-cols-1 lg:grid-cols-[1fr_220px] gap-8'>
    <article class='overflow-hidden rounded-[22px] border border-border bg-surface shadow-soft'>
      <img
        src={meta.coverImage}
        alt={meta.title}
        width='1200'
        height='630'
        class='block h-auto w-full border-b border-border'
        loading='eager'
      />
      <div class='p-4 md:p-8'>
        <p class='mb-2 font-bold text-brand'>Article</p>
        <h1 class='text-[clamp(2rem,4vw,3.25rem)] leading-[1.08] tracking-[-0.03em]'>{meta.title}</h1>
        <div class='mt-3'>
          <PostMetaView post={meta} />
        </div>
        <article
          class='prose prose-slate mt-5 max-w-[72ch] prose-headings:tracking-[-0.02em] prose-a:text-brand-strong prose-a:underline prose-code:rounded prose-code:border prose-code:border-[#dfe7f7] prose-code:bg-[#eef2fb] prose-code:px-1.5 prose-code:py-0.5 prose-code:text-[#26324d] prose-code:before:content-none prose-code:after:content-none prose-pre:rounded-[14px] prose-pre:border prose-pre:border-[#232a3a] prose-pre:bg-[#11131a] prose-pre:text-[#f4f6fa] prose-img:max-w-[280px] prose-img:rounded-[14px] prose-img:border prose-img:border-border prose-img:shadow-[0_12px_30px_rgba(22,24,29,0.10)]'
        >
          <Content components={components} />
        </article>
      </div>
    </article>

    <aside class='hidden lg:block sticky top-24 h-fit'>
      <div class='border-l-2 border-border pl-4'>
        <h4 class='text-sm font-bold text-muted uppercase tracking-wider mb-4'>On this page</h4>
        <nav class='space-y-2'>
          {filteredHeadings.map((heading: { depth: number; slug: string; text: string }) => (
            <a
              href={`#${heading.slug}`}
              class={`block text-sm text-gray-500 hover:text-brand transition ${
                heading.depth === 3 ? 'pl-4' : ''
              }`}
            >
              {heading.text}
            </a>
          ))}
        </nav>
      </div>
    </aside>
  </div>
</SiteLayout>
